<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edit Product</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
        >
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link href="Add&Edit.css" rel="stylesheet">
    </head>
    <body>
        <div class="form-container">
            <div class="dropdown">
                <a
                    href="#"
                    class="nav-link icons text-secondary-emphasis me-1 dropdown-toggle"
                    id="userDropdown"
                    role="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                >
                    Go To
                </a>
                <ul class="dropdown-menu" aria-labelledby="userDropdown">
                    <li>
                        <a class="dropdown-item" href="../profile-page/profile.html">
                            <i class="fa-solid fa-user"></i>
                            Your Profile
                        </a
            >
                    </li>
                    <li>
                        <a class="dropdown-item" href="../HomePage.html">
                            <i class="fa-solid fa-house"></i>
                            Home
                        </a
            >
                    </li>
                    <li>
                        <a class="dropdown-item" href="../AddProduct.html">
                            <i class="fas fa-plus-circle"></i>
                            Add Product
                        </a>
                    </li>
                </ul>
            </div>
            <h2>Edit Product</h2>
            <hr>
            <form id="editProductForm">
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="productName" class="form-label">
                            Enter Product Name
                        </label
            >
                        <input
                            type="text"
                            class="form-control"
                            id="productName"
                            required
                        >
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="productPrice" class="form-label">
                            Enter Product Price
                        </label
            >
                        <input
                            type="number"
                            class="form-control"
                            id="productPrice"
                            step="any"
                            required
                        >
                    </div>
                    <div class="col-md-6">
                        <label for="productQuantity" class="form-label">
                            Enter Product Quantity
                        </label
            >
                        <input
                            type="number"
                            class="form-control"
                            id="productQuantity"
                            min="1"
                            required
                        >
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="productCategory" class="form-label">
                            Select Category
                        </label
            >
                        <div class="input-group">
                            <select
                                class="form-select custom-select"
                                id="productCategory"
                                aria-label="Select category"
                                required
                            >
                                <option value="1">Comedy</option>
                                <option value="2">Novels</option>
                                <option value="3">Tragedy</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="productDescription" class="form-label">
                            Description
                        </label
            >
                        <textarea
                            class="form-control"
                            id="productDescription"
                            style="height: 100px"
                            required
                        ></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="productImage" class="form-label">Upload Image</label>
                        <input
                            type="file"
                            class="form-control"
                            id="productImage"
                            accept="image/*"
                        >
                    </div>
                </div>
                <div
                class="text-center"
                style="display: flex; justify-content: center; align-items: center"
              >
                <button
                  type="submit"
                  class="btn btn-primary"
                  style="padding: 5px 8px; font-size: 1.2rem"
                >
                  Submit
                </button>
                <i
                  class="fa-solid fa-trash"
                  id="deleteProduct"
                  style="
                    background-color: gray;
                    padding: 10px;
                    color: #ac0c0c;
                    margin-left: 8px;
                    cursor: pointer;
                    font-size: 1.1rem;
                  "
                ></i>
              </div>
            </form>
        </div>
        <script>
          window.onload = function () {
            const productIndex = localStorage.getItem("editProductIndex");
          
            if (productIndex !== null) {
              const products = JSON.parse(localStorage.getItem("products")) || [];
              const product = products[productIndex];
          
              document.getElementById("productName").value = product.name;
              document.getElementById("productPrice").value = product.price;
              document.getElementById("productQuantity").value = product.quantity;
              document.getElementById("productCategory").value = product.category;
              document.getElementById("productDescription").value = product.description;
            }
          };
          
          const form = document.getElementById("editProductForm");
          form.onsubmit = function (e) {
            e.preventDefault();
          
            const productName = document.getElementById("productName").value.trim();
            const productPrice = document.getElementById("productPrice").value.trim();
            const productQuantity = document.getElementById("productQuantity").value.trim();
            const productCategory = document.getElementById("productCategory").value.trim();
            const productDescription = document.getElementById("productDescription").value.trim();
            const productImageInput = document.getElementById("productImage");
          
            let productImage = null;
            let valid = true;
          
            // Validate Product Name (only letters, numbers, and spaces)
            if (!/^[a-zA-Z0-9\s]+$/.test(productName)) {
              alert("Product name should only contain letters, numbers, and spaces.");
              valid = false;
            }
          
            // Validate Product Price (should be a positive number)
            if (parseFloat(productPrice) <= 0 || isNaN(productPrice)) {
              alert("Product price must be a positive number.");
              valid = false;
            }
          
            // Validate Product Quantity (should be a positive integer)
            if (parseInt(productQuantity) <= 0 || isNaN(productQuantity)) {
              alert("Product quantity must be a positive integer.");
              valid = false;
            }
          
            // Validate Product Category (should be selected)
            if (!productCategory) {
              alert("Please select a category.");
              valid = false;
            }
          
            // Validate Description (should have at least 10 alphabetic characters)
            if ((productDescription.match(/[a-zA-Z]/g) || []).length < 10) {
              alert("Description must contain at least 10 alphabetic characters.");
              valid = false;
            }
          
            // Validate Image (should be a valid image file if selected)
            if (productImageInput.files.length > 0 && !productImageInput.files[0].type.startsWith("image/")) {
              alert("Please upload a valid image.");
              valid = false;
            }
          
            if (!valid) {
              return; // Stop execution if validation fails
            }
          
            // Retrieve products and the current product
            const products = JSON.parse(localStorage.getItem("products")) || [];
            const productIndex = localStorage.getItem("editProductIndex");
            const currentProduct = products[productIndex];
          
            // Check if the name, description, or image already exists
            const existingProduct = products.find(
              (p, index) =>
                (p.name === productName || p.description === productDescription) &&
                index !== parseInt(productIndex)
            );
          
            if (existingProduct) {
              alert("Product with this name or description already exists. Please choose a different one.");
              return;
            }
          
            // Handle image and update product
            if (productImageInput.files && productImageInput.files[0]) {
              const reader = new FileReader();
              reader.onloadend = function () {
                productImage = reader.result; // Get the base64 encoded image
          
                // Check if the image already exists in other products
                const imageExists = products.some(
                  (p, index) =>
                    p.image === productImage && index !== parseInt(productIndex)
                );
          
                if (imageExists) {
                  alert("This product image already exists. Please choose a different image.");
                  return; // Stop execution if the image already exists
                }
          
                const updatedProduct = {
                  name: productName,
                  price: productPrice,
                  quantity: productQuantity,
                  category: productCategory,
                  description: productDescription,
                  image: productImage, // Save the new base64 image string
                };
          
                products[productIndex] = updatedProduct;
                localStorage.setItem("products", JSON.stringify(products));
          
                alert("Product updated successfully!");
                window.location.href = "ProductsSearch.html"; // Redirect after saving
              };
              reader.readAsDataURL(productImageInput.files[0]); // Convert the image to base64
            } else {
              // If no new image is selected, retain the existing image
              const updatedProduct = {
                name: productName,
                price: productPrice,
                quantity: productQuantity,
                category: productCategory,
                description: productDescription,
                image: currentProduct.image, // Retain the existing image
              };
          
              products[productIndex] = updatedProduct;
              localStorage.setItem("products", JSON.stringify(products));
          
              alert("Product updated successfully!");
              window.location.href = "ProductsSearch.html";
            }
          };
          
      document.getElementById("deleteProduct").onclick = function () {
        const confirmation = confirm(
          "Are you sure you want to delete this product?"
        );

        if (confirmation) {
          const productIndex = localStorage.getItem("editProductIndex");

          if (productIndex !== null) {
            let products = JSON.parse(localStorage.getItem("products")) || [];
            products.splice(productIndex, 1); // Remove the product from the array

            localStorage.setItem("products", JSON.stringify(products)); // Update the localStorage
            window.location.href = "ProductsSearch.html"; // Redirect to the product list page
          }
        }
      };
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
